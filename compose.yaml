# -----------------------------------------------------------------------------
# Shared configuration for all n8n containers
# -----------------------------------------------------------------------------
x-shared: &shared
  image: docker.n8n.io/n8nio/n8n:latest
  restart: always
  environment:
    # --- Database (Postgres) ---
    - DB_TYPE=postgresdb
    - DB_POSTGRESDB_HOST=postgres
    - DB_POSTGRESDB_PORT=5432
    - DB_POSTGRESDB_DATABASE=${POSTGRES_DB}
    - DB_POSTGRESDB_USER=${POSTGRES_NON_ROOT_USER}
    - DB_POSTGRESDB_PASSWORD=${POSTGRES_NON_ROOT_PASSWORD}
    # --- Execution/Queue mode ---
    - EXECUTIONS_MODE=queue
    - OFFLOAD_MANUAL_EXECUTIONS_TO_WORKERS=true
    # --- Redis (Bull queue backend) ---
    - QUEUE_BULL_REDIS_HOST=redis
    - QUEUE_BULL_REDIS_PORT=6379
    - QUEUE_HEALTH_CHECK_ACTIVE=true
    # --- Security/Runtime ---
    - N8N_ENCRYPTION_KEY=${ENCRYPTION_KEY}
    - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=true
    - N8N_RESTRICT_FILE_ACCESS_TO=/home/node
    - N8N_GIT_NODE_DISABLE_BARE_REPOS=true
    # --- Networking/Reverse Proxy ---
    - N8N_HOST=${N8N_HOST}
    - N8N_PROTOCOL=https
    - WEBHOOK_URL=https://${N8N_HOST}
    - N8N_PROXY_HOPS=1 # Set if using a reverse proxy
    # --- Task Runners (n8n 2.x) ---
    - N8N_RUNNERS_ENABLED=true
    - N8N_RUNNERS_MODE=external
    - N8N_RUNNERS_AUTH_TOKEN=${N8N_RUNNERS_AUTH_TOKEN}
    - N8N_RUNNERS_BROKER_LISTEN_ADDRESS=0.0.0.0
    # --- Misc ---
    - TZ=${TZ} # Example timezone
  links:
    - postgres
    - redis
  volumes:
    - ./n8n_storage:/home/node/.n8n
    - ./n8n-files:/home/node/.n8n-files
  depends_on:
    redis:
      condition: service_healthy
    postgres:
      condition: service_healthy
services:
  postgres:
    image: postgres:16
    restart: always
    environment:
      - POSTGRES_USER=${POSTGRES_PASSWORD}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_NON_ROOT_USER=${POSTGRES_NON_ROOT_USER}
      - POSTGRES_NON_ROOT_PASSWORD=${POSTGRES_NON_ROOT_PASSWORD}
    volumes:
      - ./db_storage:/var/lib/postgresql/data
      - ./init-data.sh:/docker-entrypoint-initdb.d/init-data.sh
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -h localhost -U ${POSTGRES_USER} -d ${POSTGRES_DB}']
      interval: 5s
      timeout: 5s
      retries: 10
  redis:
    image: redis:6-alpine
    restart: always
    volumes:
      - ./redis_storage:/data
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 5s
      timeout: 5s
      retries: 10
  n8n:
    <<: *shared
    ports:
      - 5678:5678
  n8n-worker:
    <<: *shared
    command: worker
    depends_on:
      - n8n
  n8n-runners-main:
    image: n8nio/runners:2.0.0
    restart: always
    environment:
      - N8N_RUNNERS_TASK_BROKER_URI=http://n8n:5679
      - N8N_RUNNERS_AUTH_TOKEN=${N8N_RUNNERS_AUTH_TOKEN}
    depends_on:
      - n8n
  n8n-runners-worker:
    image: n8nio/runners:2.0.0
    restart: always
    environment:
      - N8N_RUNNERS_TASK_BROKER_URI=http://n8n-worker:5679
      - N8N_RUNNERS_AUTH_TOKEN=${N8N_RUNNERS_AUTH_TOKEN}
    depends_on:
      - n8n-worker
